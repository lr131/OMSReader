# Приложение для чтения данных с карт ОМС

> Файл постоянно обновляется в соответствие с вносимыми изменениями в программу!  Некоторые моменты (и комменты) явно отсылают к Капитану О. Уж лучше так, чем постоянно изобретать велосипед.

### Version от 3.03.2016
На данный момент приложение чисто консольное. 

Порядок действий простой:

  - Ставим библиотеки (о них ниже)
  - Подключаем ридер ACR38U-I1
  - В консоли запускаем  
```sh
$ python omsread.py
```

### Tech

Для запуска приложения потребуется:

* [OpenSuse 42.1] - Приложение тестируется на версиях 42.1 и 13.1
* [Python 2.7]
> ***Важно!*** На OpenSuse для пакетов ACR 38 следует использовать не официальный репозиторий, а репозиторий ```security:chipcard```. Разница в версиях и в файлах библиотеки PCSC.
* [PCSC-ACR38] - Драйвер для  ACR 38 smart card reader фирмы ACS. Официальный релиз использует библиотеку  PCSC-Lite .
* [Library for PC/SC IFD Handler] - Драйвер для  ACR 38 smart card reader фирмы ACS. 
* [pyscard] - Скачать последнюю версию, распаковать архив. От рута скопировать ``smartcard`` в библиотеки  Python2.7. Варианты пути могут быть такие:
* * ``/usr/lib/python/site-package/``,
* * ``/usr/lib64/python2.7/site-packages/``
* [python-pyscard] - Эту библиотеку можно покставить как с сайта, так и найти в Yast'е.
> Перед установкой пакета через Yast следует проверить список репозиториев и удалить устаревшие, несоответствующие версии текущей системы. В противном случае программа не сработает даже в случае всех установленых выше пакетов.

## Описание

Программа  считывает с карты ОМС данные и формирует из них пакет json. 

#### Поля пакета:
- `pol_ser: None` - Серия полиса. Поскольку у карт серии нет, поле всегда пустое.
- `pol_num:` - Номер полиса
- `policy:` - Номер полиса (поле в соответствии с ТФОМС)
- `family:` - Фамилия
- `name:` - Имя
- `patr:` - Отчество
- `sex:` - Пол. True - мужской, False - женский
- `bdate:` - Дата рождения. Формат YYYY-MM-DD
- `country_code:` - Код страны согласно ГОСТ 7.67-2003. Данные могут отсутствовать
- `country:` - Кириллическое название страны. Данные могут отсутствовать
- `snils:` - Снилс. Обычно отсутствует.
- `dataend:` - Дата окончания действия полиса. Как правило, пустует, т.к. полис такого вида не ограничен. Формат YYYY-MM-DD.
- `bplace: ` - Место рождения.
- `data_make_oms:` - Дата изготовления ЭП. Формат YYYY-MM-DD.
- `fimg:` - Данные о формате фотографии. Предполагаются форматы JPEG И JPEG2000, но обычно поле пустует.
- `img:` Данные изображения в соответствии с форматом. Чаще отсутствует.
- `ogrn:` - ОГРН страховой медицинской организации.
- `okato:` - ОКАТО субъекта РФ, на территории которого застрахован гражданин
- `data_start_insurance:`- Дата начала страхования ***в текущей СМО***
- `data_end_insurance:` - Дата окончания страхования ***в текущей СМО***. Поле пустое, заполнится, когда СМО сменится.
- `ecp: ` - Электронная цифровая подпись.  Хранится в виде двоичных данных.  В этой версии данное поле не записывается в пакет.

#### Функции:
- `bcd_to_int(bcd)` - переводит число из формата BCD в формат INT. На вход принимает число в формате BCD.
- `find2elements(data, arg1, arg2)` - функция ищет в списке data два идущих друг за другом элемента arg1 и arg2. Возвращает индекс arg2. Если такое сочетание не найдено,возвращает -1.
- `read_tag(data, *tags)` - функция считывает из списка data данные (в нашем случае это поток байтов), обозначенные тэгами tags. На сегодняшний день функция корректно работает с двумя тэгами. Для карт ОМС  этого хватает за глаза.


   [OpenSuse 42.1]: <http://software.opensuse.org/421/en>
   [Python 2.7]: <https://www.python.org/download/releases/2.7/>
   [PCSC-ACR38]: <http://software.opensuse.org/package/pcsc-acr38>
   [Library for PC/SC IFD Handler]: <http://software.opensuse.org/package/libacr38ucontrol0>
   [pyscard]: <https://sourceforge.net/projects/pyscard/>
   [python-pyscard]: <http://software.opensuse.org/package/python-pyscard>
